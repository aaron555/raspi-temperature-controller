#! /bin/bash

# Control setpoint (stored in file 'setpoint') for use with temperature controller

# Allow all group users to write to files created by this script
umask 002

# Set default working directory same as this script location (containing setpoint file)
WORKING_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# See if WORKING_DIR is set in config file, /etc always takes precedence
if [[ -s /etc/controller.conf ]]; then
  source "/etc/controller.conf"
elif [[ -s config/controller.conf ]]; then
  # Try relative path if being run straight from repo- only works if running from repo root
  source "config/controller.conf"
fi

DIR="${WORKING_DIR}"

# If no arguments are specified, read current setpoint and exit
if [ "$#" -eq 0 ]; then
  if [[ -s "$DIR/setpoint" ]]; then
    read setpoint < "$DIR/setpoint"
    datestr=$(date -u +"%F-%T:")
    echo "$datestr Setpoint: $setpoint" >&2; exit 0
  else
    echo "ERROR: cannot find setpoint file $DIR/setpoint or file is empty, and no new setpoint specified"
    exit 1
  fi
fi

# If setpoint is specified, check it's a valid float
re='^[0-9]+([.][0-9]+)?$'
if ! [[ "${1}" =~ $re ]] ; then
  echo "ERROR: Setpoint must be a number" >&2; exit 1
fi

if [[ ! -d ${DIR} ]]; then
  echo "ERROR: Specified working directory ${DIR} does not exist - cannot create setpoint file" >&2; exit 1
fi

# Write new setpoint to setpoint file
echo "${1}" >  "$DIR/setpoint"
read setpoint <  "$DIR/setpoint"
datestr=$(date -u +"%F-%T:")
# If log is specified in config file, output to log as well as STDOUT
if [[ ! -z "${CONTROLLER_LOGFILE}" ]]; then
  echo "$datestr Setpoint: $setpoint" >>  "${CONTROLLER_LOGFILE}"
  if [[ $? -ne 0 ]]; then
    echo "WARNING: Cannot open / write to logfile ${CONTROLLER_LOGFILE} - check filename is correct and permissions?"
  fi
fi
echo "$datestr Setpoint: $setpoint"
